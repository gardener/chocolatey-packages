name: Remote Dispatch Action

on:
  repository_dispatch:

  workflow_dispatch:
    inputs:
      component:
        description: 'Component (gardenlogin | gardenctl-v2 | diki)'
        required: true
        type: string
      tag:
        description: 'Version / tag (e.g. v1.4.0)'
        required: true
        type: string
      windows_sha:
        description: 'Optional sha256 for the Windows binary (defaults to dummy hash)'
        required: false
        type: string
      push_to_chocolatey:
        description: 'Set true to push the .nupkg (default: false → dry-run)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write          # push branch
  pull-requests: write     # open PR

##############################################################################
# 1) common job – derive CLEAN_VERSION once
##############################################################################
jobs:
  package-push-common:
    runs-on: windows-latest
    outputs:
      cleaned_version: ${{ steps.version.outputs.cleaned_version }}

    env:
      TAG: >-
        ${{ github.event_name == 'repository_dispatch'
            && github.event.client_payload.tag
            || inputs.tag }}

    steps:
      - name: Event summary
        run: |
          echo "Triggered by  : ${{ github.event_name }}"
          echo "Component      : ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.component || inputs.component }}"
          echo "Version tag    : ${{ env.TAG }}"
          echo "windows_sha    : ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.windows_sha || inputs.windows_sha }}"

      - name: Extract numeric version
        id: version
        shell: pwsh
        run: |
          $v = "${{ env.TAG }}".Replace('v','')
          echo "cleaned_version=$v" >> $env:GITHUB_OUTPUT

##############################################################################
# 2) matrix job – one row per component, only matching row executes
##############################################################################
  package-push:
    runs-on: windows-latest
    needs: package-push-common

    strategy:
      matrix:
        include:
          - component: gardenlogin
            script: .github\workflows\update-gardenlogin.ps1
            nuspec: gardenlogin\gardenlogin.nuspec
            pkg_dir: gardenlogin
            pkg_name: gardenlogin
            skip_var: SKIP_CHOCO_PUSH_GARDENLOGIN
            extra_paths:
              - gardenlogin\tools\chocolateyinstall.ps1
              - gardenlogin\tools\chocolateyuninstall.ps1

          - component: gardenctl-v2
            script: .github\workflows\update-gardenctl-v2.ps1
            nuspec: gardenctl-v2\gardenctl-v2.nuspec
            pkg_dir: gardenctl-v2
            pkg_name: gardenctl-v2
            skip_var: SKIP_CHOCO_PUSH_GARDENCTL_V2
            extra_paths:
              - gardenctl-v2\tools\chocolateyinstall.ps1

          - component: diki
            script: .github\workflows\update-diki.ps1
            nuspec: diki\diki.nuspec
            pkg_dir: diki
            pkg_name: diki
            skip_var: SKIP_CHOCO_PUSH_DIKI
            extra_paths:
              - diki\tools\chocolateyinstall.ps1

    # only the row whose component matches the payload runs
    if: |
      ${{
        matrix.component ==
        (github.event_name == 'repository_dispatch'
          && github.event.client_payload.component
          || inputs.component)
      }}

    env:
      # sha from event or manual input; default to dummy hash
      WINDOWS_SHA: >-
        ${{ github.event_name == 'repository_dispatch'
            && github.event.client_payload.windows_sha
            || inputs.windows_sha
            || 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855' }}

      NUM_VERSION: ${{ needs.package-push-common.outputs.cleaned_version }}

      FULL_TAG: >-
        ${{ github.event_name == 'repository_dispatch'
            && github.event.client_payload.tag
            || inputs.tag }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      # --- update nuspec + install scripts ----------------------------------
      - name: Update package source files
        shell: pwsh
        run: |
          & "${{ matrix.script }}" `
            "${{ env.FULL_TAG }}" `
            "${{ env.WINDOWS_SHA }}"

      # --- choco pack --------------------------------------------------------
      - name: Choco pack
        shell: pwsh
        run: |
          choco pack ${{ matrix.nuspec }} `
                     --version ${{ env.NUM_VERSION }} `
                     -y `
                     --outdir ${{ matrix.pkg_dir }}

      # --- choco push (skippable) -------------------------------------------
      - name: Choco push
        if: ${{ vars[matrix.skip_var] != 'true' &&
                (github.event_name == 'repository_dispatch' ||
                 (github.event_name == 'workflow_dispatch' && inputs.push_to_chocolatey == 'true')) }}
        shell: pwsh
        env:
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: |
          choco push "${{ matrix.pkg_dir }}\${{ matrix.pkg_name }}.${{ env.NUM_VERSION }}.nupkg" `
                     --source https://chocolatey.org `
                     -k $Env:CHOCOLATEY_API_KEY

      - name: Choco push skipped
        if: ${{ vars[matrix.skip_var] == 'true' ||
                (github.event_name == 'workflow_dispatch' && inputs.push_to_chocolatey != 'true') }}
        run: echo "Choco push step was skipped for ${{ matrix.component }}."

      # --- create / update PR -----------------------------------------------
      - name: Create pull request
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          branch="update_${{ matrix.component }}_${{ env.FULL_TAG }}"
          git switch -c "$branch"

          # stage the .nupkg + nuspec + any extra paths
          git add "${{ matrix.pkg_dir }}\\${{ matrix.pkg_name }}.${{ env.NUM_VERSION }}.nupkg"
          git add "${{ matrix.nuspec }}"
          for path in ${{ join(matrix.extra_paths, ' ') }}; do git add "$path"; done

          git commit -m "update ${{ matrix.component }} to ${{ env.FULL_TAG }}"
          git push --force-with-lease -u origin "$branch"

          gh pr create \
            --head "$branch" \
            --base "${{ github.event.repository.default_branch }}" \
            --title "update ${{ matrix.component }} to ${{ env.FULL_TAG }}" \
            --body  "This PR adds or updates the Chocolatey package for **${{ matrix.component }}** (${ env.FULL_TAG }) and updates the package sources."
